generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum OrderStatus {
  PENDING
  PAID
  PROCESSING
  COMPLETED
  CANCELLED
  FAILED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
  EXPIRED
}

enum UserRole {
  USER
  ADMIN
}

enum ForestStatus {
  ACTIVE
  MONITORING
  INACTIVE
}

enum CertificateStatus {
  active
  revoked
  expired
}

model User {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  supabaseUserId String?        @unique
  firstName      String
  lastName       String
  company        String?
  role           UserRole       @default(USER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  orders         Order[]
  cartItems      CartItem[]
  emailVerified  Boolean        @default(false)

  @@index([email])
  @@index([role])
  @@index([supabaseUserId])
}

model Forest {
  id          Int            @id @default(autoincrement())
  name        String
  location    String
  type        String
  area        Float
  description String
  status      ForestStatus   @default(ACTIVE)
  lastUpdated DateTime
  createdAt   DateTime       @default(now())
  deletedAt   DateTime?
  credits     CarbonCredit[]

  @@index([status])
}

model CarbonCredit {
  id               Int            @id @default(autoincrement())
  forestId         Int
  vintage          Int
  certification    String
  totalCredits     Int
  availableCredits Int
  pricePerCredit   Float
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?
  forest           Forest         @relation(fields: [forestId], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
  cartItems        CartItem[]
  symbol           String         @default("tCOâ‚‚")
  retiredCredits   Int            @default(0)
  exchangeRates    ExchangeRate[]

  @@index([forestId])
  @@index([vintage])
  @@index([certification])
}

model ExchangeRate {
  id             Int          @id @default(autoincrement())
  carbonCredit   CarbonCredit @relation(fields: [carbonCreditId], references: [id], onDelete: Cascade)
  carbonCreditId Int
  rate           Float
  currency       String       @default("USD")
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  orderItems     OrderItem[]

  @@index([carbonCreditId])
  @@index([effectiveFrom])
}

model Order {
  id              Int            @id @default(autoincrement())
  orderCode       Int            @unique
  userId          Int
  createdAt       DateTime       @default(now())
  status          OrderStatus    @default(PENDING)
  totalPrice      Float
  totalCredits    Int            @default(0)
  currency        String         @default("USD")
  totalUsd        Float          @default(0)
  deletedAt       DateTime?
  user            User           @relation(fields: [userId], references: [id], onDelete: Restrict)
  items           OrderItem[]
  seller          String
  buyer           String
  paidAt          DateTime?
  shippingAddress String?
  failureReason   String?
  paymentProvider String         @default("PAYOS")
  payments        Payment[]
  orderHistory    OrderHistory[]
  certificate     Certificate?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([orderCode])
}

model OrderItem {
  id             Int           @id @default(autoincrement())
  orderId        Int
  carbonCreditId Int
  quantity       Int
  pricePerCredit Float
  subtotal       Float
  usdAmount      Float         @default(0)
  exchangeRate   ExchangeRate? @relation(fields: [exchangeRateId], references: [id])
  exchangeRateId Int?
  order          Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  carbonCredit   CarbonCredit  @relation(fields: [carbonCreditId], references: [id], onDelete: Restrict)
  retired        Boolean       @default(false)

  @@index([orderId])
  @@index([carbonCreditId])
}

model CartItem {
  id             Int          @id @default(autoincrement())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         Int
  carbonCredit   CarbonCredit @relation(fields: [carbonCreditId], references: [id], onDelete: Cascade)
  carbonCreditId Int
  quantity       Int
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  addedAt        DateTime     @default(now())

  @@unique([userId, carbonCreditId])
  @@index([userId])
}

model Payment {
  id                 Int           @id @default(autoincrement())
  orderId            Int
  order              Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderCode          Int
  amount             Float
  currency           String        @default("USD")
  status             PaymentStatus @default(PENDING)
  failureReason      String?
  method             String?
  paidAt             DateTime?
  paymentData        Json?
  payosPaymentLinkId String?
  payosOrderCode     Int?
  payosReference     String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([orderId])
  @@index([orderCode])
  @@index([status])
  @@index([payosPaymentLinkId])
}

model OrderHistory {
  id        Int      @id @default(autoincrement())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId   Int
  event     String
  message   String?
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([createdAt])
}

model Certificate {
  id              String            @id @default(cuid())
  orderId         Int               @unique
  order           Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  certificateHash String            @unique
  issuedAt        DateTime          @default(now())
  status          CertificateStatus @default(active)
  metadata        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([orderId])
  @@index([status])
}

model WebhookEvent {
  id           String    @id @default(cuid())
  orderCode    Int
  signature    String    @unique
  status       String    @default("RETRYING")
  processedAt  DateTime?
  retryCount   Int       @default(0)
  errorMessage String?
  webhookData  Json
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([orderCode])
  @@index([signature])
  @@index([status, createdAt])
  @@index([createdAt])
}
